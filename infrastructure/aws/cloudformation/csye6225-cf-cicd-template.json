{
	"AWSTemplateFormatVersion": "2010-09-09",

	"Resources": {


		"TravisUploadToS3": {
			"Type": "AWS::IAM::ManagedPolicy",
			"Properties": {
				"Description": "Policy for Travis to put objects in S3",
				"Path": "/",
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Action": [
							"s3:PutObject"
						],
						"Resource": [
							"arn:aws:s3:::code-deploy.*",
							"arn:aws:s3:::web-app.*"
						]
					}]
				},
				"Users": ["travis"]
			}
		},

		"TravisCodeDeploy": {
			"Type": "AWS::IAM::ManagedPolicy",
			"Properties": {
				"Description": "Policy for Travis to call codedeploy to initiate deployment on EC2",
				"Path": "/",
				"PolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
							"Effect": "Allow",
							"Action": [
								"codedeploy:RegisterApplicationRevision",
								"codedeploy:GetApplicationRevision"
							],

							"Resource": ["arn:aws:codedeploy:us-east-1:515649345368:application:CSYE6225WebappCodeDeploy"]
	
						},
						{
							"Effect": "Allow",
							"Action": [
								"codedeploy:CreateDeployment",
								"codedeploy:GetDeployment"
							],
							"Resource": [
								"*"
							]
						},
						{
							"Effect": "Allow",
							"Action": [
								"codedeploy:GetDeploymentConfig"
							],
							"Resource": [
							"arn:aws:codedeploy:us-east-1:515649345368:deploymentconfig:CodeDeployDefault.OneAtATime",
							"arn:aws:codedeploy:us-east-1:515649345368:deploymentconfig:CodeDeployDefault.HalfAtATime",
							"arn:aws:codedeploy:us-east-1:515649345368:deploymentconfig:CodeDeployDefault.AllAtOnce"
							]
						}
					]
				},
				"Users": ["travis"]
			}
		},

		"CodeDeployServiceRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"RoleName": "CodeDeployServiceRole",
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": "codedeploy.amazonaws.com"
						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"ManagedPolicyArns": ["arn:aws:iam::aws:policy/service-role/AWSCodeDeployRole"],
				"Path": "/"
			}
		},


		"ec2role": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"RoleName": "EC2_Codedeploy_S3",

				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": ["ec2.amazonaws.com"]

						},
						"Action": ["sts:AssumeRole"]
					}]
				},
				"Path": "/",
				"Policies": [{
					"PolicyName": "ec2_s3_full_access1",
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [{
							"Action": [
								"s3:Get*",
								"s3:Put*",
								"s3:Delete*"
							],
							"Effect": "Allow",
							"Resource": ["arn:aws:s3:::code-deploy.csye6225-fall2018-nagarep.me.tld", "arn:aws:s3:::csye6225-fall2018-nagarep.me.tld.csye6225.com"]
						}]
					}
				}]
			}
		},

		"Ec2InstanceProfile": {
			"Type": "AWS::IAM::InstanceProfile",
			"Properties": {
				"InstanceProfileName": "ec2instanceprofile",
				"Path": "/",
				"Roles": [{
					"Ref": "ec2role"
				}]
			}
		},



		"CodeDeployApplication": {
			"Type": "AWS::CodeDeploy::Application",
			"Properties": {
				"ApplicationName": "CSYE6225WebappCodeDeploy"
			}
		},
		"S3bucket":{  
			 "Type":"AWS::S3::Bucket",
			 "Properties":{  
			    "BucketName":"code-deploy.csye6225-fall2018-nagarep.me.tld"
			 }
		      },
		"DeploymentGroup": {
			"Type": "AWS::CodeDeploy::DeploymentGroup",
			"Properties": {
				"ApplicationName": {
					"Ref": "CodeDeployApplication"
				},
				"DeploymentGroupName": "Codedeploy_groupname",
				"DeploymentStyle": {
					"DeploymentType": "IN_PLACE",
					"DeploymentOption": "WITHOUT_TRAFFIC_CONTROL"
				},
				"Ec2TagFilters": [{
					"Key": "Name",
					"Type": "KEY_AND_VALUE",
					"Value": "ec2"
				}],
				"ServiceRoleArn": {
					"Fn::GetAtt": [
						"CodeDeployServiceRole", "Arn"
					]
				}
			}


		}
	}
}

